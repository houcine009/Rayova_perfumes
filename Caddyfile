# Rayova Perfumes - Professional Production Configuration

# Config Snippets
(security_headers) {
    header {
        # Prevent MIME type sniffing
        X-Content-Type-Options nosniff
        # Clickjacking protection
        X-Frame-Options SAMEORIGIN
        # XSS filtering
        X-XSS-Protection "1; mode=block"
        # Referrer Policy
        Referrer-Policy no-referrer-when-downgrade
    }
}

(compression) {
    encode zstd gzip
}

# 1. SEO: Redirect www to non-www
www.rayovaparfums.com {
    redir https://rayovaparfums.com { uri }
}

# 2. Principal Frontend - SPA
rayovaparfums.com {
    root * /var/www/frontend
    import compression
    import security_headers
    
    # Precise SPA Routing: Don't serve index.html for missing assets
    @assets path *.js *.css *.png *.jpg *.jpeg *.gif *.svg *.ico *.webp *.woff2 *.avif *.mp4 *.webm
    handle @assets {
        file_server
        header Cache-Control "public, max-age=31536000, immutable"
    }
    
    handle {
        try_files { path } /index.html
        file_server
    }

    # Logging
    log {
        output file /var/log/caddy/frontend.log
    }
}

# 3. Backend API - Secure Proxy
api.rayovaparfums.com {
    # Proxy to backend container
    reverse_proxy backend:80 {
        header_up Host { host }
        header_up X-Real-IP { remote_host }
        header_up X-Forwarded-Proto { scheme }
    }
    
    import compression
    import security_headers

    # Professional CORS - Matches Origins dynamically
    @cors_origin header Origin regexp https:\/\/((www\.)?rayovaparfums\.com)
    
    handle @cors_origin {
        header {
            Access-Control-Allow-Origin { header.Origin }
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
            Access-Control-Allow-Headers "Content-Type, Authorization, Accept, X-Requested-With, X-CSRF-TOKEN"
            Access-Control-Allow-Credentials true
            Access-Control-Max-Age 3600
        }
    }
    
    # Preflight fix
    @options method OPTIONS
    respond @options 204

    # Logging
    log {
        output file /var/log/caddy/api.log
    }
}
