# Rayova Perfumes - Professional Caddy Configuration

# 1. SEO: Redirect www to non-www
www.rayovaparfums.com {
    redir https://rayovaparfums.com { uri }
}

# 2. Principal Frontend - SPA
rayovaparfums.com {
    root * /var/www/frontend
    
    # Global compression
    encode zstd gzip

    # Ultimate Security Headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        X-XSS-Protection "1; mode=block"
        Referrer-Policy no-referrer-when-downgrade
    }
    
    # Precise SPA Routing: Don't serve index.html for missing assets
    @assets path *.js *.css *.png *.jpg *.jpeg *.gif *.svg *.ico *.webp *.woff2 *.avif *.mp4 *.webm
    handle @assets {
        file_server
        header Cache-Control "public, max-age=31536000, immutable"
    }
    
    handle {
        try_files { path } /index.html
        file_server
    }

    # Logging
    log {
        output file /var/log/caddy/frontend.log
    }
}

# 3. Backend API
api.rayovaparfums.com {
    reverse_proxy backend:80 {
        header_up Host { host }
        header_up X-Real-IP { remote_host }
        header_up X-Forwarded-Proto { scheme }
    }
    
    encode zstd gzip

    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        X-XSS-Protection "1; mode=block"
        Referrer-Policy no-referrer-when-downgrade
    }

    # Robust CORS for both domains
    @cors_origin header Origin https://rayovaparfums.com https://www.rayovaparfums.com
    
    handle @cors_origin {
        header {
            Access-Control-Allow-Origin { http.request.header.Origin }
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
            Access-Control-Allow-Headers "Content-Type, Authorization, Accept, X-Requested-With, X-CSRF-TOKEN"
            Access-Control-Allow-Credentials true
            Access-Control-Max-Age 3600
        }
    }
    
    # Preflight fix
    @options method OPTIONS
    respond @options 204

    # Logging
    log {
        output file /var/log/caddy/api.log
    }
}
